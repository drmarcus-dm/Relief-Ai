<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relief AI</title>
    <link rel="manifest" href="manifest.json">
    <!-- Bootstrap CDN for visually appealing UI -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Compromise NLP CDN for improved offline AI sentiment analysis and entity extraction -->
    <script src="https://unpkg.com/compromise@latest"></script>
    <style>
        body {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #333;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            transition: background 0.3s, color 0.3s;
        }
        body.dark-mode {
            background: linear-gradient(135deg, #1f1f1f 0%, #434343 100%);
            color: #f0f0f0;
        }
        .container {
            max-width: 800px;
            width: 100%;
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.9);
            transition: background 0.3s;
        }
        body.dark-mode .card {
            background: rgba(50, 50, 50, 0.9);
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.1);
        }
        .card-header {
            background: linear-gradient(135deg, #89fffd 0%, #ef32d9 100%);
            color: white;
            font-weight: bold;
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
        }
        body.dark-mode .card-header {
            background: linear-gradient(135deg, #2c3e50 0%, #8e44ad 100%);
        }
        .btn-primary {
            background: linear-gradient(135deg, #89fffd 0%, #ef32d9 100%);
            border: none;
        }
        body.dark-mode .btn-primary {
            background: linear-gradient(135deg, #2c3e50 0%, #8e44ad 100%);
        }
        .breath-circle {
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, #89fffd, #ef32d9);
            border-radius: 50%;
            margin: 20px auto;
            transition: transform 4s ease-in-out, background 0.3s;
        }
        body.dark-mode .breath-circle {
            background: radial-gradient(circle, #2c3e50, #8e44ad);
        }
        .breath-inhale { transform: scale(1.5); }
        .breath-hold { transform: scale(1.5); }
        .breath-exhale { transform: scale(1); }
        #themeToggle {
            position: absolute;
            top: 20px;
            right: 20px;
        }
        #speakToggle {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <button id="themeToggle" class="btn btn-secondary">Dark Mode</button>
    <div class="container">
        <h1 class="text-center my-4 title-color">Relief AI</h1>
        <p class="text-center lead">Your offline AI companion for psychological relief. Journal your thoughts, breathe deeply, relax with ambient sounds, or use the meditation timer. Enhanced with better AI and voice guidance.</p>

        <!-- Journaling Section -->
        <div class="card">
            <div class="card-header">AI-Powered Journaling</div>
            <div class="card-body">
                <textarea id="journal" class="form-control" rows="5" placeholder="Write your thoughts here..."></textarea>
                <button id="analyzeBtn" class="btn btn-primary mt-3">Analyze with AI</button>
                <button id="saveJournal" class="btn btn-secondary mt-3 ms-2">Save Journal</button>
                <div id="result" class="mt-3"></div>
                <div id="pastJournals" class="mt-4">
                    <h5>Past Journals</h5>
                    <ul id="journalList" class="list-group"></ul>
                </div>
            </div>
        </div>

        <!-- Breathing Exercise Section -->
        <div class="card">
            <div class="card-header">Breathing Exercise</div>
            <div class="card-body text-center">
                <div id="breathCircle" class="breath-circle"></div>
                <p id="breathInstruction" class="lead">Press start to begin 4-7-8 breathing.</p>
                <button id="startBreath" class="btn btn-primary">Start Breathing</button>
                <button id="stopBreath" class="btn btn-secondary ms-2">Stop</button>
                <div class="form-check mt-3">
                    <input class="form-check-input" type="checkbox" id="speakToggle" checked>
                    <label class="form-check-label" for="speakToggle">Enable Voice Guidance</label>
                </div>
            </div>
        </div>

        <!-- Ambient Sounds Section -->
        <div class="card">
            <div class="card-header">Ambient Sounds</div>
            <div class="card-body text-center">
                <p>Play soothing sounds generated in your browser.</p>
                <select id="soundType" class="form-select mb-3">
                    <option value="white">White Noise</option>
                    <option value="pink">Pink Noise</option>
                    <option value="brown">Brown Noise</option>
                </select>
                <button id="playNoise" class="btn btn-primary">Play</button>
                <button id="stopNoise" class="btn btn-secondary ms-2">Stop</button>
            </div>
        </div>

        <!-- Meditation Timer Section -->
        <div class="card">
            <div class="card-header">Meditation Timer</div>
            <div class="card-body text-center">
                <p>Set a timer for meditation (in minutes).</p>
                <input type="number" id="timerMinutes" class="form-control mb-3" min="1" max="60" value="5">
                <button id="startTimer" class="btn btn-primary">Start Timer</button>
                <button id="stopTimer" class="btn btn-secondary ms-2">Stop</button>
                <p id="timerDisplay" class="lead mt-3">00:00</p>
            </div>
        </div>
    </div>

    <script>
        // Register Service Worker for Offline PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(reg => console.log('Service Worker registered!', reg))
                    .catch(err => console.log('Service Worker registration failed:', err));
            });
        }

        // Dark Mode Toggle with Persistence
        const themeToggle = document.getElementById('themeToggle');
        const title = document.querySelector('.title-color');
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
            themeToggle.textContent = 'Light Mode';
            title.style.color = '#8e44ad';
        } else {
            title.style.color = '#ef32d9';
        }
        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            themeToggle.textContent = isDark ? 'Light Mode' : 'Dark Mode';
            title.style.color = isDark ? '#8e44ad' : '#ef32d9';
            localStorage.setItem('darkMode', isDark);
        });

        // Predefined suggestions based on sentiment
        const positiveSuggestions = [
            "Great mindset! Keep it up with a short walk.",
            "Positive vibes! Try smiling at yourself in the mirror.",
            "Awesome! Share your positivity with a friend."
        ];
        const neutralSuggestions = [
            "Balanced thoughts. Take a moment to stretch.",
            "Neutral day? Read an inspiring quote.",
            "Steady on. Hydrate and breathe deeply."
        ];
        const negativeSuggestions = [
            "Tough times? Try the breathing exercise below.",
            "Feeling down? List three things you're grateful for.",
            "Challenges ahead? Listen to ambient sounds to relax."
        ];

        // Journal Analysis with Compromise NLP
        document.getElementById('analyzeBtn').addEventListener('click', () => {
            const text = document.getElementById('journal').value;
            if (!text) return;
            const doc = nlp(text);
            const sentiment = doc.sentiment();
            const people = doc.people().out('array');
            const places = doc.places().out('array');
            const orgs = doc.organizations().out('array');
            const topics = doc.topics().out('array');
            const entities = [...new Set([...people, ...places, ...orgs])]; // Unique entities
            let suggestion;
            if (sentiment > 0.3) {
                suggestion = positiveSuggestions[Math.floor(Math.random() * positiveSuggestions.length)];
            } else if (sentiment < -0.3) {
                suggestion = negativeSuggestions[Math.floor(Math.random() * negativeSuggestions.length)];
            } else {
                suggestion = neutralSuggestions[Math.floor(Math.random() * neutralSuggestions.length)];
            }
            let entityList = entities.length ? `<br><strong>Key Entities:</strong> ${entities.join(', ')}` : '';
            let topicList = topics.length ? `<br><strong>Topics:</strong> ${topics.join(', ')}` : '';
            document.getElementById('result').innerHTML = `<strong>Sentiment Score:</strong> ${sentiment.toFixed(2)}<br><strong>AI Suggestion:</strong> ${suggestion}${entityList}${topicList}`;
        });

        // Save Journal to Local Storage
        document.getElementById('saveJournal').addEventListener('click', () => {
            const text = document.getElementById('journal').value;
            if (!text) return;
            let journals = JSON.parse(localStorage.getItem('journals')) || [];
            journals.push({ date: new Date().toLocaleString(), text });
            localStorage.setItem('journals', JSON.stringify(journals));
            loadJournals();
            document.getElementById('journal').value = '';
        });

        // Load Past Journals
        function loadJournals() {
            const journalList = document.getElementById('journalList');
            journalList.innerHTML = '';
            let journals = JSON.parse(localStorage.getItem('journals')) || [];
            journals.forEach((j, index) => {
                const li = document.createElement('li');
                li.classList.add('list-group-item');
                li.innerHTML = `<strong>${j.date}</strong><br>${j.text.substring(0, 100)}... <button class="btn btn-sm btn-danger float-end deleteBtn" data-index="${index}">Delete</button>`;
                journalList.appendChild(li);
            });
            // Add delete listeners
            document.querySelectorAll('.deleteBtn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = e.target.dataset.index;
                    journals.splice(index, 1);
                    localStorage.setItem('journals', JSON.stringify(journals));
                    loadJournals();
                });
            });
        }
        loadJournals();

        // Breathing Exercise with Voice Guidance
        let breathInterval, lastInstruction = '';
        const speakToggle = document.getElementById('speakToggle');
        function speak(text) {
            if (speakToggle.checked && 'speechSynthesis' in window && text !== lastInstruction) {
                const utterance = new SpeechSynthesisUtterance(text);
                speechSynthesis.speak(utterance);
                lastInstruction = text;
            }
        }
        document.getElementById('startBreath').addEventListener('click', () => {
            const circle = document.getElementById('breathCircle');
            const instruction = document.getElementById('breathInstruction');
            clearInterval(breathInterval);
            lastInstruction = '';
            let phase = 0;
            breathInterval = setInterval(() => {
                if (phase === 0) {
                    instruction.textContent = 'Inhale (4s)';
                    speak('Inhale');
                    circle.classList.add('breath-inhale');
                    circle.classList.remove('breath-exhale', 'breath-hold');
                } else if (phase === 4) {
                    instruction.textContent = 'Hold (7s)';
                    speak('Hold');
                    circle.classList.add('breath-hold');
                } else if (phase === 11) {
                    instruction.textContent = 'Exhale (8s)';
                    speak('Exhale');
                    circle.classList.add('breath-exhale');
                    circle.classList.remove('breath-inhale', 'breath-hold');
                } else if (phase === 19) {
                    phase = -1;
                }
                phase++;
            }, 1000);
        });
        document.getElementById('stopBreath').addEventListener('click', () => {
            clearInterval(breathInterval);
            document.getElementById('breathInstruction').textContent = 'Breathing stopped. Press start to begin again.';
            const circle = document.getElementById('breathCircle');
            circle.classList.remove('breath-inhale', 'breath-hold', 'breath-exhale');
            speechSynthesis.cancel();
        });

        // Ambient Sounds Generation
        let audioContext, noiseSource;
        function generateNoise(type) {
            const bufferSize = 2 * audioContext.sampleRate;
            const noiseBuffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
            const output = noiseBuffer.getChannelData(0);
            if (type === 'white') {
                for (let i = 0; i < bufferSize; i++) {
                    output[i] = Math.random() * 2 - 1;
                }
            } else if (type === 'pink') {
                let b0 = 0, b1 = 0, b2 = 0, b3 = 0, b4 = 0, b5 = 0, b6 = 0;
                for (let i = 0; i < bufferSize; i++) {
                    const white = Math.random() * 2 - 1;
                    b0 = 0.99886 * b0 + white * 0.0555179;
                    b1 = 0.99332 * b1 + white * 0.0750759;
                    b2 = 0.96900 * b2 + white * 0.1538520;
                    b3 = 0.86650 * b3 + white * 0.3104856;
                    b4 = 0.55000 * b4 + white * 0.5329522;
                    b5 = -0.7616 * b5 - white * 0.0168980;
                    output[i] = b0 + b1 + b2 + b3 + b4 + b5 + b6 + white * 0.5362;
                    output[i] *= 0.11;
                    b6 = white * 0.115926;
                }
            } else if (type === 'brown') {
                let lastOut = 0.0;
                for (let i = 0; i < bufferSize; i++) {
                    const white = Math.random() * 2 - 1;
                    output[i] = (lastOut + (0.02 * white)) / 1.02;
                    lastOut = output[i];
                    output[i] *= 3.5; // Adjust volume
                }
            }
            noiseSource = audioContext.createBufferSource();
            noiseSource.buffer = noiseBuffer;
            noiseSource.loop = true;
            noiseSource.connect(audioContext.destination);
            noiseSource.start(0);
        }

        document.getElementById('playNoise').addEventListener('click', () => {
            if (audioContext) audioContext.close();
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const soundType = document.getElementById('soundType').value;
            generateNoise(soundType);
        });
        document.getElementById('stopNoise').addEventListener('click', () => {
            if (noiseSource) noiseSource.stop();
            if (audioContext) audioContext.close();
        });

        // Meditation Timer
        let timerInterval;
        document.getElementById('startTimer').addEventListener('click', () => {
            const minutes = parseInt(document.getElementById('timerMinutes').value) || 5;
            let timeLeft = minutes * 60;
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeLeft--;
                const mins = Math.floor(timeLeft / 60);
                const secs = timeLeft % 60;
                document.getElementById('timerDisplay').textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    document.getElementById('timerDisplay').textContent = '00:00';
                    speak('Meditation complete');
                    // Play a simple tone as bell
                    const ctx = new (window.AudioContext || window.webkitAudioContext)();
                    const osc = ctx.createOscillator();
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(440, ctx.currentTime);
                    osc.connect(ctx.destination);
                    osc.start();
                    osc.stop(ctx.currentTime + 0.5);
                }
            }, 1000);
        });
        document.getElementById('stopTimer').addEventListener('click', () => {
            clearInterval(timerInterval);
            document.getElementById('timerDisplay').textContent = '00:00';
        });
    </script>
</body>
</html>
