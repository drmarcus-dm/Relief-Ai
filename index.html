<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relief AI</title>
    <link rel="manifest" href="manifest.json">
    <!-- Bootstrap CDN for responsive and professional UI -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Compromise NLP for offline sentiment analysis and entity extraction -->
    <script src="https://unpkg.com/compromise@latest"></script>
    <!-- Chart.js for sentiment trend visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #333;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            transition: background 0.5s ease, color 0.5s ease;
        }
        body.dark-mode {
            background: linear-gradient(135deg, #1f1f1f 0%, #434343 100%);
            color: #f0f0f0;
        }
        .container {
            max-width: 900px;
            width: 100%;
        }
        .card {
            border: none;
            border-radius: 20px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            margin-bottom: 40px;
            background: rgba(255, 255, 255, 0.95);
            transition: transform 0.3s ease, background 0.5s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }
        body.dark-mode .card {
            background: rgba(50, 50, 50, 0.95);
            box-shadow: 0 6px 20px rgba(255, 255, 255, 0.1);
        }
        body.dark-mode .card:hover {
            box-shadow: 0 8px 25px rgba(255, 255, 255, 0.15);
        }
        .card-header {
            background: linear-gradient(135deg, #89fffd 0%, #ef32d9 100%);
            color: white;
            font-weight: bold;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            padding: 15px;
            font-size: 1.2rem;
        }
        body.dark-mode .card-header {
            background: linear-gradient(135deg, #2c3e50 0%, #8e44ad 100%);
        }
        .btn-primary {
            background: linear-gradient(135deg, #89fffd 0%, #ef32d9 100%);
            border: none;
            transition: transform 0.2s ease;
        }
        .btn-primary:hover {
            transform: scale(1.05);
        }
        body.dark-mode .btn-primary {
            background: linear-gradient(135deg, #2c3e50 0%, #8e44ad 100%);
        }
        .breath-circle {
            width: 220px;
            height: 220px;
            background: radial-gradient(circle, #89fffd, #ef32d9);
            border-radius: 50%;
            margin: 30px auto;
            transition: transform 4s ease-in-out, background 0.5s ease;
            box-shadow: 0 0 20px rgba(239, 50, 217, 0.5);
        }
        body.dark-mode .breath-circle {
            background: radial-gradient(circle, #2c3e50, #8e44ad);
            box-shadow: 0 0 20px rgba(142, 68, 173, 0.5);
        }
        .breath-inhale { transform: scale(1.6); }
        .breath-hold { transform: scale(1.6); }
        .breath-exhale { transform: scale(1); }
        #themeToggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        #speakToggle {
            margin-top: 15px;
        }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        .list-group-item {
            transition: background 0.3s ease;
        }
        body.dark-mode .list-group-item {
            background: #333;
            color: #f0f0f0;
        }
        .title-color {
            transition: color 0.5s ease;
        }
    </style>
</head>
<body>
    <button id="themeToggle" class="btn btn-secondary"><i class="fas fa-moon"></i> Dark Mode</button>
    <div class="container">
        <h1 class="text-center my-5 title-color"><i class="fas fa-brain me-2"></i>Relief AI</h1>
        <p class="text-center lead mb-5">Your sophisticated offline AI companion for mental wellness. Journal introspectively, engage in guided breathing, immerse in ambient soundscapes, or time your meditations. Enhanced with advanced AI insights, voice assistance, and sentiment tracking.</p>

        <!-- Journaling Section -->
        <div class="card">
            <div class="card-header"><i class="fas fa-book-open me-2"></i>AI-Enhanced Journaling</div>
            <div class="card-body">
                <textarea id="journal" class="form-control mb-3" rows="6" placeholder="Pour out your thoughts here..."></textarea>
                <div class="d-flex justify-content-start mb-3">
                    <button id="analyzeBtn" class="btn btn-primary me-2"><i class="fas fa-brain me-1"></i>Analyze</button>
                    <button id="saveJournal" class="btn btn-secondary me-2"><i class="fas fa-save me-1"></i>Save</button>
                    <button id="exportJournals" class="btn btn-info"><i class="fas fa-download me-1"></i>Export</button>
                </div>
                <div id="result" class="mt-3 alert alert-info" role="alert"></div>
                <div id="sentimentChart" class="chart-container mt-4">
                    <canvas id="sentimentCanvas"></canvas>
                </div>
                <div id="pastJournals" class="mt-4">
                    <h5><i class="fas fa-history me-2"></i>Past Entries</h5>
                    <ul id="journalList" class="list-group"></ul>
                </div>
            </div>
        </div>

        <!-- Breathing Exercise Section -->
        <div class="card">
            <div class="card-header"><i class="fas fa-lungs me-2"></i>Guided Breathing</div>
            <div class="card-body text-center">
                <div id="breathCircle" class="breath-circle"></div>
                <p id="breathInstruction" class="lead mb-4">Initiate 4-7-8 breathing for calm and focus.</p>
                <div class="btn-group mb-3">
                    <button id="startBreath" class="btn btn-primary"><i class="fas fa-play me-1"></i>Start</button>
                    <button id="stopBreath" class="btn btn-secondary"><i class="fas fa-stop me-1"></i>Stop</button>
                </div>
                <div class="form-check form-switch mt-3">
                    <input class="form-check-input" type="checkbox" id="speakToggle" checked>
                    <label class="form-check-label" for="speakToggle">Voice Guidance</label>
                </div>
            </div>
        </div>

        <!-- Ambient Sounds Section -->
        <div class="card">
            <div class="card-header"><i class="fas fa-volume-up me-2"></i>Ambient Soundscapes</div>
            <div class="card-body text-center">
                <p class="mb-3">Immerse in browser-generated soothing noises. Adjust volume for optimal relaxation.</p>
                <select id="soundType" class="form-select mb-3">
                    <option value="white">White Noise</option>
                    <option value="pink">Pink Noise</option>
                    <option value="brown">Brown Noise</option>
                    <option value="rain">Simulated Rain</option>
                </select>
                <div class="btn-group mb-3">
                    <button id="playNoise" class="btn btn-primary"><i class="fas fa-play me-1"></i>Play</button>
                    <button id="stopNoise" class="btn btn-secondary"><i class="fas fa-stop me-1"></i>Stop</button>
                </div>
                <div class="mt-3">
                    <label for="volumeControl" class="form-label">Volume</label>
                    <input type="range" class="form-range" id="volumeControl" min="0" max="1" step="0.01" value="0.5">
                </div>
            </div>
        </div>

        <!-- Meditation Timer Section -->
        <div class="card">
            <div class="card-header"><i class="fas fa-clock me-2"></i>Meditation Timer</div>
            <div class="card-body text-center">
                <p class="mb-3">Customize your meditation duration (1-60 minutes).</p>
                <input type="number" id="timerMinutes" class="form-control mb-3" min="1" max="60" value="5">
                <div class="btn-group mb-3">
                    <button id="startTimer" class="btn btn-primary"><i class="fas fa-play me-1"></i>Start</button>
                    <button id="pauseTimer" class="btn btn-warning"><i class="fas fa-pause me-1"></i>Pause</button>
                    <button id="stopTimer" class="btn btn-secondary"><i class="fas fa-stop me-1"></i>Stop</button>
                </div>
                <p id="timerDisplay" class="lead mt-3">00:00</p>
            </div>
        </div>
    </div>

    <script>
        // Service Worker for PWA Offline Support
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(reg => console.log('Service Worker registered'))
                    .catch(err => console.error('Service Worker registration failed:', err));
            });
        }

        // Dark Mode Toggle with Local Storage Persistence
        const themeToggle = document.getElementById('themeToggle');
        const title = document.querySelector('.title-color');
        const isDark = localStorage.getItem('darkMode') === 'true';
        if (isDark) {
            document.body.classList.add('dark-mode');
            themeToggle.innerHTML = '<i class="fas fa-sun"></i> Light Mode';
            title.style.color = '#8e44ad';
        } else {
            title.style.color = '#ef32d9';
        }
        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            const isDarkNow = document.body.classList.contains('dark-mode');
            themeToggle.innerHTML = isDarkNow ? '<i class="fas fa-sun"></i> Light Mode' : '<i class="fas fa-moon"></i> Dark Mode';
            title.style.color = isDarkNow ? '#8e44ad' : '#ef32d9';
            localStorage.setItem('darkMode', isDarkNow);
            updateSentimentChart();
        });

        // Enhanced Suggestions with More Variety
        const positiveSuggestions = [
            "Excellent energy! Maintain it with a mindful walk in nature.",
            "Uplifting thoughts! Affirm your strengths by mirroring a smile.",
            "Radiant positivity! Spread it by connecting with a loved one."
        ];
        const neutralSuggestions = [
            "Steady balance. Invigorate with gentle stretches.",
            "Calm neutrality. Inspire yourself with a profound quote.",
            "Even keel. Replenish with hydration and deep breaths."
        ];
        const negativeSuggestions = [
            "Navigating roughness? Engage the breathing module for serenity.",
            "Low spirits? Cultivate gratitude by noting three positives.",
            "Facing hurdles? Unwind with ambient harmonies."
        ];

        // Journal Management
        let journals = JSON.parse(localStorage.getItem('journals')) || [];
        let sentimentChart;

        function analyzeJournal() {
            const text = document.getElementById('journal').value.trim();
            if (!text) {
                document.getElementById('result').innerHTML = '<strong>Error:</strong> Please enter some text.';
                return;
            }
            const doc = nlp(text);
            const sentiment = doc.sentiment() || 0;
            const people = doc.people().out('array');
            const places = doc.places().out('array');
            const orgs = doc.organizations().out('array');
            const topics = doc.topics().out('array');
            const entities = [...new Set([...people, ...places, ...orgs])];
            let category = sentiment > 0.3 ? 'positive' : sentiment < -0.3 ? 'negative' : 'neutral';
            let suggestions = { positive: positiveSuggestions, neutral: neutralSuggestions, negative: negativeSuggestions }[category];
            let suggestion = suggestions[Math.floor(Math.random() * suggestions.length)];
            let entityList = entities.length ? `<br><strong>Extracted Entities:</strong> ${entities.join(', ')}` : '';
            let topicList = topics.length ? `<br><strong>Key Topics:</strong> ${topics.join(', ')}` : '';
            document.getElementById('result').innerHTML = `<strong>Sentiment:</strong> ${sentiment.toFixed(2)} (${category.charAt(0).toUpperCase() + category.slice(1)})<br><strong>AI Insight:</strong> ${suggestion}${entityList}${topicList}`;
        }

        function saveJournal() {
            const text = document.getElementById('journal').value.trim();
            if (!text) return;
            const doc = nlp(text);
            const sentiment = doc.sentiment() || 0;
            journals.push({ date: new Date().toLocaleString(), text, sentiment });
            localStorage.setItem('journals', JSON.stringify(journals));
            loadJournals();
            updateSentimentChart();
            document.getElementById('journal').value = '';
            document.getElementById('result').innerHTML = '<strong>Success:</strong> Journal saved.';
        }

        function loadJournals() {
            const journalList = document.getElementById('journalList');
            journalList.innerHTML = '';
            journals.forEach((j, index) => {
                const li = document.createElement('li');
                li.classList.add('list-group-item', 'd-flex', 'justify-content-between', 'align-items-start');
                li.innerHTML = `
                    <div>
                        <strong>${j.date}</strong><br>
                        ${j.text.substring(0, 100)}...
                    </div>
                    <div>
                        <button class="btn btn-sm btn-primary editBtn me-1" data-index="${index}"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger deleteBtn" data-index="${index}"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                journalList.appendChild(li);
            });
            // Event Listeners for Edit/Delete
            journalList.querySelectorAll('.deleteBtn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.closest('.deleteBtn').dataset.index);
                    journals.splice(index, 1);
                    localStorage.setItem('journals', JSON.stringify(journals));
                    loadJournals();
                    updateSentimentChart();
                });
            });
            journalList.querySelectorAll('.editBtn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.closest('.editBtn').dataset.index);
                    document.getElementById('journal').value = journals[index].text;
                    document.getElementById('result').innerHTML = '<strong>Editing:</strong> Make changes and save to update.';
                    // Remove old entry after edit
                    journals.splice(index, 1);
                });
            });
        }

        function exportJournals() {
            const blob = new Blob([JSON.stringify(journals, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'relief-ai-journals.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function updateSentimentChart() {
            const ctx = document.getElementById('sentimentCanvas').getContext('2d');
            const labels = journals.map(j => j.date.split(',')[0]); // Simplified date
            const data = journals.map(j => j.sentiment);
            const isDark = document.body.classList.contains('dark-mode');
            if (sentimentChart) sentimentChart.destroy();
            sentimentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Sentiment Trend',
                        data,
                        borderColor: isDark ? '#8e44ad' : '#ef32d9',
                        backgroundColor: isDark ? 'rgba(142, 68, 173, 0.2)' : 'rgba(239, 50, 217, 0.2)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { min: -1, max: 1, title: { display: true, text: 'Sentiment Score' } }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        document.getElementById('analyzeBtn').addEventListener('click', analyzeJournal);
        document.getElementById('saveJournal').addEventListener('click', saveJournal);
        document.getElementById('exportJournals').addEventListener('click', exportJournals);
        loadJournals();
        updateSentimentChart();

        // Breathing Exercise with Improved Voice and Countdown
        let breathInterval, lastInstruction = '', phaseTime = 0;
        const speakToggle = document.getElementById('speakToggle');
        function speak(text) {
            if (speakToggle.checked && 'speechSynthesis' in window && text !== lastInstruction) {
                const utterance = new SpeechSynthesisUtterance(text);
                speechSynthesis.speak(utterance);
                lastInstruction = text;
            }
        }
        document.getElementById('startBreath').addEventListener('click', () => {
            const circle = document.getElementById('breathCircle');
            const instruction = document.getElementById('breathInstruction');
            clearInterval(breathInterval);
            lastInstruction = '';
            let phase = 'inhale';
            phaseTime = 0;
            breathInterval = setInterval(() => {
                phaseTime++;
                if (phase === 'inhale') {
                    if (phaseTime === 1) {
                        instruction.textContent = 'Inhale for 4 seconds...';
                        speak('Inhale slowly');
                        circle.classList.add('breath-inhale');
                        circle.classList.remove('breath-exhale', 'breath-hold');
                    }
                    if (phaseTime === 4) {
                        phase = 'hold';
                        phaseTime = 0;
                    }
                } else if (phase === 'hold') {
                    if (phaseTime === 1) {
                        instruction.textContent = 'Hold for 7 seconds...';
                        speak('Hold your breath');
                        circle.classList.add('breath-hold');
                    }
                    if (phaseTime === 7) {
                        phase = 'exhale';
                        phaseTime = 0;
                    }
                } else if (phase === 'exhale') {
                    if (phaseTime === 1) {
                        instruction.textContent = 'Exhale for 8 seconds...';
                        speak('Exhale gently');
                        circle.classList.add('breath-exhale');
                        circle.classList.remove('breath-inhale', 'breath-hold');
                    }
                    if (phaseTime === 8) {
                        phase = 'inhale';
                        phaseTime = 0;
                    }
                }
            }, 1000);
        });
        document.getElementById('stopBreath').addEventListener('click', () => {
            clearInterval(breathInterval);
            document.getElementById('breathInstruction').textContent = 'Breathing paused. Restart when ready.';
            document.getElementById('breathCircle').classList.remove('breath-inhale', 'breath-hold', 'breath-exhale');
            speechSynthesis.cancel();
        });

        // Ambient Sounds with Volume Control and Additional Rain Simulation
        let audioContext, noiseSource, gainNode;
        function generateNoise(type) {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                gainNode = audioContext.createGain();
                gainNode.connect(audioContext.destination);
            }
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            gainNode.gain.value = document.getElementById('volumeControl').value;
            if (noiseSource) {
                noiseSource.disconnect();
            }
            const bufferSize = 4096;
            noiseSource = audioContext.createScriptProcessor(bufferSize, 1, 1);
            noiseSource.onaudioprocess = (e) => {
                const output = e.outputBuffer.getChannelData(0);
                if (type === 'white') {
                    for (let i = 0; i < bufferSize; i++) output[i] = Math.random() * 2 - 1;
                } else if (type === 'pink') {
                    let b0 = 0, b1 = 0, b2 = 0, b3 = 0, b4 = 0, b5 = 0, b6 = 0;
                    for (let i = 0; i < bufferSize; i++) {
                        const white = Math.random() * 2 - 1;
                        b0 = 0.99886 * b0 + white * 0.0555179;
                        b1 = 0.99332 * b1 + white * 0.0750759;
                        b2 = 0.96900 * b2 + white * 0.1538520;
                        b3 = 0.86650 * b3 + white * 0.3104856;
                        b4 = 0.55000 * b4 + white * 0.5329522;
                        b5 = -0.7616 * b5 - white * 0.0168980;
                        output[i] = (b0 + b1 + b2 + b3 + b4 + b5 + b6 + white * 0.5362) * 0.11;
                        b6 = white * 0.115926;
                    }
                } else if (type === 'brown') {
                    let lastOut = 0.0;
                    for (let i = 0; i < bufferSize; i++) {
                        const white = Math.random() * 2 - 1;
                        output[i] = (lastOut + (0.02 * white)) / 1.02;
                        lastOut = output[i];
                        output[i] *= 3.5;
                    }
                } else if (type === 'rain') {
                    for (let i = 0; i < bufferSize; i++) {
                        output[i] = (Math.random() * 2 - 1) * Math.random() * 0.5; // Varied intensity
                    }
                }
            };
            noiseSource.connect(gainNode);
        }

        document.getElementById('playNoise').addEventListener('click', () => {
            const soundType = document.getElementById('soundType').value;
            generateNoise(soundType);
        });
        document.getElementById('stopNoise').addEventListener('click', () => {
            if (noiseSource) noiseSource.disconnect();
            if (audioContext) audioContext.suspend();
        });
        document.getElementById('volumeControl').addEventListener('input', (e) => {
            if (gainNode) gainNode.gain.value = e.target.value;
        });

        // Meditation Timer with Pause/Resume
        let timerInterval, timeLeft = 0, isPaused = false;
        document.getElementById('startTimer').addEventListener('click', () => {
            if (isPaused) {
                isPaused = false;
                return;
            }
            const minutes = parseInt(document.getElementById('timerMinutes').value) || 5;
            timeLeft = minutes * 60;
            clearInterval(timerInterval);
            timerInterval = setInterval(updateTimer, 1000);
        });
        document.getElementById('pauseTimer').addEventListener('click', () => {
            isPaused = !isPaused;
            document.getElementById('pauseTimer').innerHTML = isPaused ? '<i class="fas fa-play me-1"></i>Resume' : '<i class="fas fa-pause me-1"></i>Pause';
        });
        document.getElementById('stopTimer').addEventListener('click', () => {
            clearInterval(timerInterval);
            timeLeft = 0;
            isPaused = false;
            document.getElementById('timerDisplay').textContent = '00:00';
            document.getElementById('pauseTimer').innerHTML = '<i class="fas fa-pause me-1"></i>Pause';
        });
        function updateTimer() {
            if (isPaused || timeLeft <= 0) return;
            timeLeft--;
            const mins = Math.floor(timeLeft / 60);
            const secs = timeLeft % 60;
            document.getElementById('timerDisplay').textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                speak('Meditation session complete. Well done.');
                // Gentle bell sound
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(432, ctx.currentTime); // Calming frequency
                osc.connect(ctx.destination);
                osc.start();
                osc.stop(ctx.currentTime + 1);
            }
        }
    </script>
</body>
</html>
